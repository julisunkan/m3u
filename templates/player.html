
{% extends "base.html" %}

{% block title %}{{ channel.name }} - M3U Player{% endblock %}

{% block head %}
<style>
    .player-container {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: #000;
        border-bottom: 1px solid #dee2e6;
    }
    .video-wrapper {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        background: #000;
    }
    .video-wrapper video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .player-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: white;
        cursor: pointer;
        transition: opacity 0.3s ease;
    }
    .player-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }
    .play-button {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.9;
    }
    .player-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1001;
    }
    .resolution-selector {
        background: rgba(0,0,0,0.8);
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }
    .channel-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Player Container -->
    <div class="player-container">
        <div class="container py-3">
            <!-- Channel Info -->
            <div class="channel-info rounded mb-3">
                <div class="d-flex align-items-center">
                    {% if channel.logo_url %}
                    <img src="{{ channel.logo_url }}" alt="{{ channel.name }}" 
                         class="me-3" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;" loading="lazy">
                    {% endif %}
                    <div>
                        <h4 class="mb-1" id="channel-name">{{ channel.name }}</h4>
                        <p class="mb-0">
                            <i class="bi bi-collection-play"></i> {{ channel.playlist.name }}
                            {% if channel.group_title %}
                            <span class="ms-2"><i class="bi bi-tag"></i> {{ channel.group_title }}</span>
                            {% endif %}
                            <span class="ms-2" id="resolution-info">
                                <i class="bi bi-camera-video"></i> <span id="current-resolution">Click to play</span>
                            </span>
                            <span class="ms-2" id="stream-status">
                                <span class="badge bg-secondary">
                                    <i class="bi bi-hourglass-split"></i> Ready
                                </span>
                            </span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Video Player -->
            <div class="video-wrapper">
                <video id="video-player" class="w-100 h-100" controls crossorigin="anonymous" preload="none">
                    <p>Your browser does not support HTML5 video.</p>
                </video>
                
                <!-- Player Overlay (Click to Play) -->
                <div class="player-overlay" id="player-overlay">
                    <div class="play-button">
                        <i class="bi bi-play-circle"></i>
                    </div>
                    <h5>Click to Start Playing</h5>
                    <p class="text-center">Video will load when you click play</p>
                </div>
                
                <!-- Player Controls -->
                <div class="player-controls">
                    <select id="resolution-selector" class="resolution-selector">
                        <option value="">Loading streams...</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Channel Details -->
    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary mb-4">
                    <i class="bi bi-arrow-left"></i> Back to Channel List
                </a>
                
                <!-- Stream Information -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle"></i> Stream Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Channel:</strong> {{ channel.name }}</p>
                                <p><strong>Playlist:</strong> {{ channel.playlist.name }}</p>
                                {% if channel.group_title %}
                                <p><strong>Category:</strong> {{ channel.group_title }}</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <p><strong>Available Streams:</strong> {{ channel.streams.count() }}</p>
                                <p><strong>Stream Type:</strong> <span id="stream-type">Not loaded</span></p>
                                <p><strong>Status:</strong> <span id="connection-status">Ready to play</span></p>
                            </div>
                        </div>
                        
                        <!-- Available Streams List -->
                        <div class="mt-3">
                            <h6>Available Resolutions:</h6>
                            <div id="streams-list" class="row">
                                {% for stream in channel.streams %}
                                <div class="col-md-4 mb-2">
                                    <div class="card border-secondary">
                                        <div class="card-body p-2">
                                            <small class="text-muted">
                                                {{ stream.resolution_label }}
                                                {% if stream.is_hls %}
                                                <span class="badge bg-success ms-1">HLS</span>
                                                {% elif stream.needs_proxy %}
                                                <span class="badge bg-warning ms-1">Proxy</span>
                                                {% else %}
                                                <span class="badge bg-info ms-1">Direct</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class OptimizedVideoPlayer {
    constructor(channelId) {
        this.channelId = channelId;
        this.video = document.getElementById('video-player');
        this.overlay = document.getElementById('player-overlay');
        this.resolutionSelector = document.getElementById('resolution-selector');
        this.currentResolutionSpan = document.getElementById('current-resolution');
        this.streamTypeSpan = document.getElementById('stream-type');
        this.connectionStatusSpan = document.getElementById('connection-status');
        this.hls = null;
        this.streams = [];
        this.currentStream = null;
        this.isInitialized = false;
        
        this.init();
    }
    
    async init() {
        try {
            // Fetch stream data
            const response = await fetch(`/api/channel/${this.channelId}/streams`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            this.streams = data.streams;
            
            if (this.streams.length === 0) {
                this.showError('No streams available for this channel');
                return;
            }
            
            // Populate resolution selector
            this.populateResolutionSelector();
            
            // Setup event listeners
            this.setupEventListeners();
            
            // Update status
            this.updateConnectionStatus('Ready - Click to play');
            
        } catch (error) {
            console.error('Error initializing player:', error);
            this.showError('Failed to load stream data: ' + error.message);
        }
    }
    
    populateResolutionSelector() {
        this.resolutionSelector.innerHTML = '';
        
        this.streams.forEach((stream, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = stream.resolution_label;
            this.resolutionSelector.appendChild(option);
        });
        
        this.resolutionSelector.value = '0'; // Select first stream by default
    }
    
    setupEventListeners() {
        // Play button click
        this.overlay.addEventListener('click', () => {
            this.startPlayback();
        });
        
        // Resolution selector
        this.resolutionSelector.addEventListener('change', (e) => {
            if (this.isInitialized) {
                const streamIndex = parseInt(e.target.value);
                if (streamIndex >= 0 && streamIndex < this.streams.length) {
                    this.loadStream(this.streams[streamIndex]);
                }
            }
        });
        
        // Video events
        this.video.addEventListener('error', (e) => {
            console.error('Video error:', e);
            this.updateConnectionStatus('Playback error');
            this.showError('Video playback error - stream may be offline');
        });
        
        this.video.addEventListener('loadstart', () => {
            this.updateConnectionStatus('Loading...');
        });
        
        this.video.addEventListener('canplay', () => {
            this.updateConnectionStatus('Ready to play');
        });
        
        this.video.addEventListener('playing', () => {
            this.updateConnectionStatus('Playing');
            this.overlay.classList.add('hidden');
        });
        
        this.video.addEventListener('waiting', () => {
            this.updateConnectionStatus('Buffering...');
        });
        
        this.video.addEventListener('pause', () => {
            this.updateConnectionStatus('Paused');
        });
    }
    
    async startPlayback() {
        if (this.isInitialized) {
            this.video.play();
            return;
        }
        
        this.isInitialized = true;
        this.updateConnectionStatus('Initializing...');
        
        // Check channel status first
        try {
            await this.checkChannelStatus();
        } catch (error) {
            console.warn('Status check failed, continuing anyway');
        }
        
        // Load default stream
        this.loadStream(this.streams[0]);
    }
    
    async checkChannelStatus() {
        try {
            const response = await fetch(`/api/channel/${this.channelId}/status`);
            const data = await response.json();
            this.updateStreamStatus(data.status, data.reason);
        } catch (error) {
            console.error('Error checking channel status:', error);
            this.updateStreamStatus('UNKNOWN', 'Status check failed');
        }
    }
    
    updateStreamStatus(status, reason = '') {
        const statusElement = document.getElementById('stream-status');
        if (statusElement) {
            if (status === 'ONLINE') {
                statusElement.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> ONLINE</span>';
            } else {
                const reasonText = reason ? ` (${reason})` : '';
                statusElement.innerHTML = `<span class="badge bg-danger"><i class="bi bi-x-circle"></i> ${status}${reasonText}</span>`;
            }
        }
    }
    
    updateConnectionStatus(status) {
        this.connectionStatusSpan.textContent = status;
    }
    
    loadStream(stream) {
        this.currentStream = stream;
        this.currentResolutionSpan.textContent = stream.resolution_label;
        
        // Clean up previous HLS instance
        if (this.hls) {
            this.hls.destroy();
            this.hls = null;
        }
        
        // Determine stream type and load accordingly
        if (stream.is_hls || stream.url.toLowerCase().includes('.m3u8')) {
            this.loadHLSStream(stream);
        } else {
            this.loadDirectStream(stream);
        }
    }
    
    loadHLSStream(stream) {
        this.streamTypeSpan.textContent = 'HLS (.m3u8)';
        
        if (Hls.isSupported()) {
            this.hls = new Hls({
                debug: false,
                enableWorker: true,
                lowLatencyMode: false,
                backBufferLength: 90,
                maxBufferLength: 30,
                maxMaxBufferLength: 60
            });
            
            this.hls.loadSource(stream.url);
            this.hls.attachMedia(this.video);
            
            this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                console.log('HLS manifest loaded, found', this.hls.levels.length, 'quality levels');
                this.updateConnectionStatus('Ready');
                this.video.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                    this.updateConnectionStatus('Click play to start');
                });
            });
            
            this.hls.on(Hls.Events.ERROR, (event, data) => {
                console.error('HLS error:', data);
                if (data.fatal) {
                    this.updateConnectionStatus('Stream error');
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            this.updateConnectionStatus('Network error - retrying...');
                            this.hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            this.updateConnectionStatus('Media error - recovering...');
                            this.hls.recoverMediaError();
                            break;
                        default:
                            this.updateConnectionStatus('Fatal error');
                            this.showError('Stream playback failed - channel may be offline');
                            break;
                    }
                }
            });
            
        } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari native HLS support
            this.video.src = stream.url;
            this.video.addEventListener('loadedmetadata', () => {
                this.video.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                });
            });
        } else {
            this.showError('HLS not supported in this browser');
        }
    }
    
    loadDirectStream(stream) {
        // Determine stream type for display
        const streamUrl = stream.url.toLowerCase();
        if (streamUrl.includes('.mp4')) {
            this.streamTypeSpan.textContent = 'Direct (MP4)';
        } else if (streamUrl.includes('.ts')) {
            this.streamTypeSpan.textContent = 'Direct (TS)';
        } else {
            this.streamTypeSpan.textContent = 'Direct Stream';
        }
        
        // Use proxy if needed, otherwise direct URL
        const playUrl = stream.needs_proxy ? `/proxy/${stream.id}` : stream.url;
        this.video.src = playUrl;
        
        this.video.addEventListener('loadedmetadata', () => {
            this.video.play().catch(e => {
                console.log('Autoplay prevented:', e);
            });
        });
    }
    
    showError(message) {
        // Update connection status
        this.updateConnectionStatus('Error');
        
        // Show error in overlay
        this.overlay.innerHTML = `
            <div class="text-center">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                <h5 class="mt-3">Playback Error</h5>
                <p>${message}</p>
                <button class="btn btn-light" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Retry
                </button>
            </div>
        `;
        this.overlay.classList.remove('hidden');
        
        // Also show alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
        alertDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstElementChild);
        
        // Remove error after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }
}

// Initialize player when page loads
document.addEventListener('DOMContentLoaded', () => {
    const channelId = {{ channel.id }};
    new OptimizedVideoPlayer(channelId);
});
</script>
{% endblock %}
